json_graph = {"id": 1, "version": "123", "process_graph_node_id": 1, "process_id": 1, "created_at": "2014-06-11T15:15:21.929Z", "updated_at": "2014-06-11T15:15:21.929Z", "process_graph_nodes": [{"id": 9, "process_version_id": 1, "priority": null, "owner": "all", "complete_globally": null, "when_complete_invalidate_nodes": [], "name": "", "description": "", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.054Z", "updated_at": "2014-06-11T15:15:22.054Z"}, {"id": 8, "process_version_id": 1, "priority": null, "owner": "seller", "complete_globally": null, "when_complete_invalidate_nodes": [], "name": "", "description": "", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.050Z", "updated_at": "2014-06-11T15:15:22.050Z"}, {"id": 7, "process_version_id": 1, "priority": null, "owner": "admin", "complete_globally": null, "when_complete_invalidate_nodes": [2 ], "name": "Aprove test drive test", "description": "Click here to aprove the test drive test", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.046Z", "updated_at": "2014-06-11T15:15:22.194Z"}, {"id": 6, "process_version_id": 1, "priority": null, "owner": "seller", "complete_globally": true, "when_complete_invalidate_nodes": [], "name": "Add the title and registration", "description": "Our pre-sale checklist will help you verify  your ownership docs are in order", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.042Z", "updated_at": "2014-06-11T15:15:22.183Z"}, {"id": 5, "process_version_id": 1, "priority": null, "owner": "seller", "complete_globally": true, "when_complete_invalidate_nodes": [], "name": "Add your legal name and address", "description": "You'll be preparing your closing docs at no charge", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.038Z", "updated_at": "2014-06-11T15:15:22.173Z"}, {"id": 4, "process_version_id": 1, "priority": null, "owner": "seller", "complete_globally": true, "when_complete_invalidate_nodes": [], "name": "Bank Account", "description": "Add your bank account", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "More info...", "more_info_text": "You'll need this to complete the sale", "created_at": "2014-06-11T15:15:22.034Z", "updated_at": "2014-06-11T15:15:22.160Z"}, {"id": 3, "process_version_id": 1, "priority": null, "owner": "buyer", "complete_globally": null, "when_complete_invalidate_nodes": [], "name": "Take a test drive", "description": "Click here when you are done with the test drive", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.030Z", "updated_at": "2014-06-11T15:15:22.030Z"}, {"id": 2, "process_version_id": 1, "priority": null, "owner": "buyer", "complete_globally": null, "when_complete_invalidate_nodes": [], "name": "I plan to pay with cash.", "description": "Click here to use our escrow service", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.025Z", "updated_at": "2014-06-11T15:15:22.025Z"}, {"id": 1, "process_version_id": 1, "priority": null, "owner": "all", "complete_globally": null, "when_complete_invalidate_nodes": [], "name": "", "description": "", "url": "", "url_text": "", "img_url": null, "fail_text": null, "more_info": "", "more_info_text": "", "created_at": "2014-06-11T15:15:22.016Z", "updated_at": "2014-06-11T15:15:22.016Z"} ], "process_graph_edges": [{"id": 12, "process_graph_node_id": 8, "end_node_id": 9, "created_at": "2014-06-11T15:15:22.190Z", "updated_at": "2014-06-11T15:15:22.190Z"}, {"id": 8, "process_graph_node_id": 7, "end_node_id": 8, "created_at": "2014-06-11T15:15:22.151Z", "updated_at": "2014-06-11T15:15:22.151Z"}, {"id": 11, "process_graph_node_id": 6, "end_node_id": 8, "created_at": "2014-06-11T15:15:22.180Z", "updated_at": "2014-06-11T15:15:22.180Z"}, {"id": 10, "process_graph_node_id": 5, "end_node_id": 8, "created_at": "2014-06-11T15:15:22.169Z", "updated_at": "2014-06-11T15:15:22.169Z"}, {"id": 9, "process_graph_node_id": 4, "end_node_id": 8, "created_at": "2014-06-11T15:15:22.157Z", "updated_at": "2014-06-11T15:15:22.157Z"}, {"id": 7, "process_graph_node_id": 3, "end_node_id": 7, "created_at": "2014-06-11T15:15:22.144Z", "updated_at": "2014-06-11T15:15:22.144Z"}, {"id": 6, "process_graph_node_id": 2, "end_node_id": 8, "created_at": "2014-06-11T15:15:22.137Z", "updated_at": "2014-06-11T15:15:22.137Z"}, {"id": 1, "process_graph_node_id": 1, "end_node_id": 2, "created_at": "2014-06-11T15:15:22.105Z", "updated_at": "2014-06-11T15:15:22.105Z"}, {"id": 2, "process_graph_node_id": 1, "end_node_id": 3, "created_at": "2014-06-11T15:15:22.113Z", "updated_at": "2014-06-11T15:15:22.113Z"}, {"id": 3, "process_graph_node_id": 1, "end_node_id": 4, "created_at": "2014-06-11T15:15:22.119Z", "updated_at": "2014-06-11T15:15:22.119Z"}, {"id": 4, "process_graph_node_id": 1, "end_node_id": 5, "created_at": "2014-06-11T15:15:22.124Z", "updated_at": "2014-06-11T15:15:22.124Z"}, {"id": 5, "process_graph_node_id": 1, "end_node_id": 6, "created_at": "2014-06-11T15:15:22.130Z", "updated_at": "2014-06-11T15:15:22.130Z"} ] }

var nodes = [
      {id: 0, reflexive: false },
      {id: 1, reflexive: false },
      {id: 2, reflexive: false }
    ]

var links = [
  {source: nodes[0], target: nodes[1], left: false, right: true },
  {source: nodes[1], target: nodes[2], left: false, right: true }
];

var sanitize_graph_params = function(graph) {
  // sanitize nodes
  var sanitized_nodes_definition = {}
  graph.process_graph_nodes.forEach(function (elem) {
    var node_level;
    if (elem.id >=2 && elem.id<=6) {
        node_level = 100
    }
    else if (elem.id == 7) {
        node_level = 300
    }
    else if (elem.id == 8) {
        node_level = 400
    }
    else if (elem.id == 9) {
        node_level = 480
    }
    else {
        node_level = 30
    };
    sanitized_nodes_definition["id_" + elem.id] = {
      id:          elem.id,
      name:        elem.name,
      description: elem.description,
      priority:    elem.priority,
      owner:       elem.owner,
      y:       node_level,
      reflexive:   true,
    }
  });
  sanitized_nodes_definition.id_9.reflexive = false
  sanitized_nodes_definition.id_1.reflexive = false
  // sanitize edges
  var sanitized_edges_definition = [];
  graph.process_graph_edges.forEach(function (elem) {
    sanitized_edges_definition.push({
      source: sanitized_nodes_definition['id_' + elem.process_graph_node_id],
      target: sanitized_nodes_definition['id_' + elem.end_node_id],
      distance: ((elem.process_graph_node_id == 7) || (elem.end_node_id == 7) ) ? 50 : 100,
      left: false,
      right: true
    })
  });

  //Sanitize sanitized_nodes_definition
  keys = Object.keys(sanitized_nodes_definition);

  return {
    nodes: keys.map(function(v) { return sanitized_nodes_definition[v]; }),
    edges: sanitized_edges_definition
  };
};

sanitized_graph = sanitize_graph_params(json_graph);

json_params = {
  width: 960,
  height: 500,
  colors: d3.scale.category10(),
  nodes: sanitized_graph.nodes,
  edges: sanitized_graph.edges
}


var draw = function(params) {

  var width  = params.width,
      height = params.height,
      colors = params.colors;

  var svg = d3.select('body')
    .append('svg')
    .attr('width', width)
    .attr('height', height);

  // set up initial nodes and links
  //  - nodes are known by 'id', not by index in array.
  //  - reflexive edges are indicated on the node (as a bold black circle).
  //  - links are always source < target; edge directions are set by 'left' and 'right'.
  var nodes = params.nodes,
    links = params.edges;

  // init D3 force layout
  force = d3.layout.force()
      .nodes(nodes)
      .links(links)
      .size([width, height])
      .charge(-1000)
      .chargeDistance(200)
      .linkDistance(function(v) {return v.distance})
      .on('tick', tick)

  // define arrow markers for graph links
  svg.append('svg:defs').append('svg:marker')
      .attr('id', 'end-arrow')
      .attr('viewBox', '0 -5 10 10')
      .attr('refX', 6)
      .attr('markerWidth', 3)
      .attr('markerHeight', 3)
      .attr('orient', 'auto')
    .append('svg:path')
      .attr('d', 'M0,-5L10,0L0,5')
      .attr('fill', '#000');

  svg.append('svg:defs').append('svg:marker')
      .attr('id', 'start-arrow')
      .attr('viewBox', '0 -5 10 10')
      .attr('refX', 4)
      .attr('markerWidth', 3)
      .attr('markerHeight', 3)
      .attr('orient', 'auto')
    .append('svg:path')
      .attr('d', 'M10,-5L0,0L10,5')
      .attr('fill', '#000');

  // handles to link and node element groups
  var path = svg.append('svg:g').selectAll('path'),
      circle = svg.append('svg:g').selectAll('g');

  // mouse event vars
  var selected_node = null,
      selected_link = null,
      mousedown_link = null,
      mousedown_node = null,
      mouseup_node = null;

  // update force layout (called automatically each iteration)
  function tick() {
    // draw directed edges with proper padding from node centers
    path.attr('d', function(d) {
      var deltaX = d.target.x - d.source.x,
          deltaY = d.target.y - d.source.y,
          dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
          normX = deltaX / dist,
          normY = deltaY / dist,
          sourcePadding = d.left ? 17 : 12,
          targetPadding = d.right ? 17 : 12,
          sourceX = d.source.x + (sourcePadding * normX),
          sourceY = d.source.y + (sourcePadding * normY),
          targetX = d.target.x - (targetPadding * normX),
          targetY = d.target.y - (targetPadding * normY);
      return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
    });

    circle.attr('transform', function(d) {
      return 'translate(' + d.x + ',' + d.y + ')';
    });
  }

  // update graph (called when needed)
  function restart() {
    // path (link) group
    path = path.data(links);

    // update existing links
    path.classed('selected', function(d) { return d === selected_link; })
      .style('marker-start', function(d) { return d.left ? 'url(#start-arrow)' : ''; })
      .style('marker-end', function(d) { return d.right ? 'url(#end-arrow)' : ''; });


    // add new links
    path.enter().append('svg:path')
      .attr('class', 'link')
      .classed('selected', function(d) { return d === selected_link; })
      .style('marker-start', function(d) { return d.left ? 'url(#start-arrow)' : ''; })
      .style('marker-end', function(d) { return d.right ? 'url(#end-arrow)' : ''; })

    // circle (node) group
    // NB: the function arg is crucial here! nodes are known by id, not by index!
    circle = circle.data(nodes, function(d) { return d.id; });

    // update existing nodes (reflexive & selected visual states)
    circle.selectAll('circle')
      .style('fill', function(d) { return (d === selected_node) ? d3.rgb(colors(d.id)).brighter().toString() : colors(d.id); })
      .classed('reflexive', function(d) { return d.reflexive; });

    // add new nodes
    var g = circle.enter().append('svg:g');

    g.append('svg:circle')
      .attr('class', 'node')
      .attr('r', 12)
      .style('fill', function(d) { return (d === selected_node) ? d3.rgb(colors(d.id)).brighter().toString() : colors(d.id); })
      .style('stroke', function(d) { return d3.rgb(colors(d.id)).darker().toString(); })

    // show node IDs
    g.append('svg:text')
        .attr('x', 0)
        .attr('y', 4)
        .attr('class', 'id')
        .text(function(d) { return d.id; });

    // set the graph in motion
    force.start();
  }

  // app starts here
  restart();
}
